package me.manuloff.apps.knasu.study.telegram.handler.impl.myschedule;

import com.pengrad.telegrambot.model.Message;
import com.pengrad.telegrambot.model.request.InlineKeyboardMarkup;
import com.pengrad.telegrambot.model.request.InputMediaPhoto;
import com.pengrad.telegrambot.request.EditMessageCaption;
import com.pengrad.telegrambot.request.EditMessageMedia;
import com.pengrad.telegrambot.request.SendPhoto;
import lombok.Data;
import lombok.NonNull;
import me.manuloff.apps.knasu.study.KnasuStudy;
import me.manuloff.apps.knasu.study.api.KnasuAPI;
import me.manuloff.apps.knasu.study.api.response.ScheduleResponse;
import me.manuloff.apps.knasu.study.data.UserData;
import me.manuloff.apps.knasu.study.data.UserStage;
import me.manuloff.apps.knasu.study.renderer.ScheduleTableRenderer;
import me.manuloff.apps.knasu.study.telegram.Keyboards;
import me.manuloff.apps.knasu.study.telegram.handler.CommandHandler;
import me.manuloff.apps.knasu.study.telegram.method.DMessage;
import me.manuloff.apps.knasu.study.telegram.method.SMessage;
import me.manuloff.apps.knasu.study.util.CalendarUtils;

import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.UUID;

/**
 * @author Manuloff
 * @since 16:06 14.12.2024
 */
public class MyScheduleCommand extends CommandHandler {

	public static final Map<Long, Session> sessions = new HashMap<>();

	public MyScheduleCommand() {
		super("/my_schedule", "\uD83D\uDC64 ÐœÐ¾Ñ‘ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ");
	}

	@Override
	public void handleCommand(@NonNull Message message) {
		long userId = message.from().id();

		UserData data = UserData.of(userId);
		data.setStage(UserStage.MY_SCHEDULE);

		// ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ
		sessions.remove(userId);

		SMessage.of(userId).text("""
				ðŸ“… Ð’Ð°ÑˆÐµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ.
				
				1ï¸âƒ£ *ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ*:
				ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ `Ð”ÐµÐ½ÑŒ` Ð¸Ð»Ð¸ `ÐÐµÐ´ÐµÐ»Ñ`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ð¼ÐµÐ¶Ð´Ñƒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼ Ð½Ð° Ð¾Ð´Ð¸Ð½ Ð´ÐµÐ½ÑŒ Ð¸ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼ Ð½Ð° Ð²ÑÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ.
				
				2ï¸âƒ£ *ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°*:
				ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð¸Ð»Ð¸ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½, Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.
				
				3ï¸âƒ£ *ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ*:
				Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ `ÐŸÑ€ÐµÐ´. Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»Ñ` Ð¸ `Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»Ñ`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ðº Ð½ÑƒÐ¶Ð½Ð¾Ð¹ Ð´Ð°Ñ‚Ðµ.
				
				4ï¸âƒ£ *Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²*:
				Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ð²Ð½ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ, Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ ÐºÐ½Ð¾Ð¿ÐºÐ° `ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ`. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð½ÐµÐµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ.
				
				ðŸ“… Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¹ Ð´Ð°Ñ‚Ñ‹, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð½ÑƒÐ¶Ð½Ð¾Ð¹ Ð´Ð°Ñ‚Ð¾Ð¹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ `Ð´Ð´.Ð¼Ð¼.Ð³Ð³Ð³Ð³`.
				
				ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ! ðŸš€
				"""
		).replyMarkup(Keyboards.backToMainMenu()).execute();

		UUID id = KnasuAPI.getGroups().getGroupIdByGroupName(Objects.requireNonNull(data.getGroup()));
		assert id != null;

		SMessage.of(userId).text("""
						ðŸŒ Ð”Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸. ðŸ”—
						""")
				.replyMarkup(Keyboards.openUrl("ðŸŒ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ", "https://knastu.ru/students/schedule/" + id + "?day=" + CalendarUtils.getCurrentDay()))
				.execute();

		updateSchedule(userId, -1, CalendarUtils.getCurrentDay(), true, true);
	}

	public static void updateSchedule(long userId, int messageId, @NonNull String selectedDate, boolean daily, boolean apply) {
		Session session = sessions.computeIfAbsent(userId, (k) -> new Session());
		if (session.lock) {
			return;
		}

		session.lock = true;

		InlineKeyboardMarkup markup = Keyboards.schedule(selectedDate, daily, apply, null);

		if (apply || messageId == -1) {
			String group = UserData.of(userId).getGroup();
			assert group != null;

			UUID id = KnasuAPI.getGroups().getGroupIdByGroupName(group);
			assert id != null;

			ScheduleResponse schedule = KnasuAPI.getGroupSchedule(id, selectedDate);

			byte[] bytes = ScheduleTableRenderer.render(schedule, daily ? CalendarUtils.removeYearFromDate(selectedDate) : null);

			if (messageId == -1) {
				SendPhoto request = new SendPhoto(userId, bytes)
						.replyMarkup(markup);

				messageId = KnasuStudy.getInstance().getTelegramManager().getBot().execute(request).message().messageId();
			} else {
				EditMessageMedia request = new EditMessageMedia(userId, messageId, new InputMediaPhoto(bytes))
						.replyMarkup(markup);

				KnasuStudy.getInstance().getTelegramManager().getBot().execute(request);
			}
		} else {
			EditMessageCaption request = new EditMessageCaption(userId, messageId)
					.replyMarkup(markup);

			KnasuStudy.getInstance().getTelegramManager().getBot().execute(request);
		}

		session.messageId = messageId;
		session.daily = daily;
		session.lock = false;
	}

	@Data
	public static class Session {
		private int messageId = -1;

		private boolean daily;

		private boolean lock;
	}

	public static void removeMessageFromSession(long userId) {
		Session session = sessions.get(userId);
		if (session != null && session.messageId != -1) {
			DMessage.of(userId, session.messageId).execute();
			session.messageId = -1;
		}
	}
}
